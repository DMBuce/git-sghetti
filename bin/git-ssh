#!/bin/bash

# define some vars
prog="${0##*/}"
SUBDIRECTORY_OK=Yes
NONGIT_OK=Yes
OPTIONS_KEEPDASHDASH=
OPTIONS_STUCKLONG=
OPTIONS_SPEC="\
${prog/-/ } <command>

SSH into the remote repository of the current branch and run \`<command>\`.
--
 Options
h,help!    Show this help message and exit.
"

# normalize options, set up shell functions, define $GIT_DIR, $GIT_OBJECT_DIRECTORY
. "$(git --exec-path)/git-sh-setup"

# print help output if called with no args
if [[ -z "$*" || "$*" == '--' ]]; then
	usage
fi

# parse options
while (( $# )); do
	case "$1" in
		--)
			shift
			break
		;;
		-*)
			die "Unimplemented option (this is a bug): $1"
		;;
		*)
			break
		;;
	esac
	shift
done

# parse args
cmd="$*"

# parse remote url
. <(git-sghetti)

# make sure we have an ssh url
if [[ "$flavor" != ssh ]]; then
	die "Not an ssh url: $url"
fi

# determine ssh target
target="$host"
if [[ -n "$user" ]]; then
	target="$user@$host"
fi

# ssh into [user@]host, create repo dir if necessary,
# switch to repo, and run command
ssh "$target" "mkdir -p $dir && cd $dir || exit; $cmd"

